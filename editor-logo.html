<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Publifly Studio ‚Äî Editor Avanzado</title>

<!-- Fuentes -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Roboto:wght@400;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

<!-- html2canvas para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  /* ===== Base (mantener est√©tica previa: colores c√°lidos/pastel) ===== */
  :root{
    --pr: #f39f30;
    --sec: #f8bb60;
    --bg: #fff7f0;
    --panel: #fff6ef;
    --accent: #f3c268;
    --text: #2d2d2d;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Poppins", "Roboto", sans-serif;
    background: linear-gradient(120deg,#f6bdc0,#fdf6f0,#f3c268);
    min-height:100vh;
    color:var(--text);
    -webkit-font-smoothing:antialiased;
  }

  /* Header */
  header{
    display:flex;justify-content:space-between;align-items:center;
    padding:18px 24px;background:var(--sec);border-bottom:4px solid var(--pr);
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }
  header h1{ margin:0; font-weight:800; font-size:1.25rem; color:#fff; letter-spacing:0.2px; }
  .top-actions{display:flex;gap:10px;align-items:center;}
  .btn{background:var(--pr);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:2px solid rgba(255,255,255,0.15);color:#fff}
  .btn.small{padding:8px 10px;border-radius:8px;font-size:0.9rem}

  /* Layout */
  .app{display:flex; gap:18px; padding:18px; height:calc(100vh - 88px);}
  .sidebar{width:320px;background:var(--panel);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.06);overflow:auto}
  .middle{flex:1;display:flex;flex-direction:column;gap:12px}
  .right{width:340px;background:var(--panel);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.06);overflow:auto}

  /* Sidebar sections */
  .section-title{display:flex;align-items:center;gap:8px;margin-bottom:8px;color:var(--pr);font-weight:700}
  .palette{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .swatch{width:36px;height:36px;border-radius:8px;cursor:pointer;border:2px solid rgba(0,0,0,0.06)}
  .input, select{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:8px}

  .lib-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .lib-item{background:#fff;border-radius:8px;padding:12px;text-align:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.04)}
  .template-card{background:#fff;border-radius:10px;padding:12px;border:2px solid rgba(0,0,0,0.03);cursor:pointer}

  /* Canvas area */
  .canvas-wrap{background:linear-gradient(180deg,#fff,#fffaf7);border-radius:12px;padding:18px;display:flex;justify-content:center;align-items:center;flex:1}
  #canvas{width:920px;height:600px;border-radius:12px;background:var(--bg);position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.08);overflow:hidden}

  /* Element styles (draggable items) */
  .item{position:absolute;cursor:move;touch-action:none;display:flex;align-items:center;justify-content:center}
  .item .content{pointer-events:auto}
  .text-item{min-width:80px;min-height:32px;padding:10px;border-radius:8px;background:transparent;font-weight:600}
  .img-item{display:block;max-width:100%;height:auto;border-radius:8px}
  .shape{width:120px;height:120px;border-radius:10px;background:var(--pr)}
  .selected{outline:3px dashed rgba(0,0,0,0.12);box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  /* handles */
  .handle{position:absolute;width:12px;height:12px;background:#fff;border:2px solid var(--pr);border-radius:2px;z-index:50}
  .handle.br{right:-8px;bottom:-8px;cursor:se-resize}
  .handle.tl{left:-8px;top:-8px;cursor:nw-resize}
  .rotate-handle{position:absolute;top:-36px;left:50%;transform:translateX(-50%);width:18px;height:18px;border-radius:50%;background:var(--pr);display:flex;align-items:center;justify-content:center;color:#fff;cursor:grab}

  /* Right panel controls */
  .control-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  label.small{font-size:0.85rem;color:#666;margin-top:10px;display:block}
  .range{width:100%}

  /* Layer list */
  .layer{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fff;margin-bottom:8px;cursor:pointer}
  .layer .hb{display:flex;gap:8px;align-items:center}

  /* Responsive */
  @media (max-width:1100px){
    .app{flex-direction:column;padding:12px;height:calc(100vh - 140px)}
    .sidebar,.right{width:100%;height:220px;overflow:auto}
    .middle{order:2}
    .right{order:3}
  }
</style>
</head>
<body>

<header>
  <div>
    <h1>PUBLIFLY STUDIO</h1>
    <div style="font-size:0.85rem;color:#fff8;margin-top:6px">Dise√±a logos incre√≠bles ‚Äî muchas herramientas, plantillas y exportaci√≥n</div>
  </div>
  <div class="top-actions">
    <button class="btn small" onclick="abrirGaleria()">Plantillas</button>
    <button class="btn small" onclick="exportarPNG()">Exportar PNG</button>
    <button class="btn small" onclick="guardarProyecto()">Guardar</button>
    <button class="btn ghost small" onclick="limpiarCanvas()">Limpiar</button>
  </div>
</header>

<div class="app">
  <!-- LEFT: TOOLS / LIBRARY -->
  <aside class="sidebar">
    <div class="section-title">üìö Biblioteca</div>

    <div>
      <div style="display:flex;gap:8px;">
        <button class="btn small" onclick="addText()">+ Texto</button>
        <button class="btn small" onclick="addHeading()">+ H1</button>
        <button class="btn small" onclick="addShape('rect')">+ Forma</button>
      </div>
      <div style="height:10px"></div>

      <label class="small">Subir imagen</label>
      <input type="file" id="fileImage" class="input" accept="image/*" onchange="handleUpload(event)">

      <label class="small">Iconos r√°pidos</label>
      <div class="lib-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px">
        <div class="lib-item" onclick="insertIcon('üåü')">üåü</div>
        <div class="lib-item" onclick="insertIcon('‚ú®')">‚ú®</div>
        <div class="lib-item" onclick="insertIcon('‚ù§Ô∏è')">‚ù§Ô∏è</div>
        <div class="lib-item" onclick="insertIcon('üéØ')">üéØ</div>
        <div class="lib-item" onclick="insertIcon('üîó')">üîó</div>
        <div class="lib-item" onclick="insertIcon('üî•')">üî•</div>
        <div class="lib-item" onclick="insertIcon('üí°')">üí°</div>
        <div class="lib-item" onclick="insertIcon('üé®')">üé®</div>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px dashed rgba(0,0,0,0.05)">

    <div>
      <div class="section-title">üé® Fondos r√°pidos</div>
      <div class="palette">
        <div class="swatch" style="background:#fff7f0" onclick="setBg('#fff7f0')"></div>
        <div class="swatch" style="background:#fff0f6" onclick="setBg('#fff0f6')"></div>
        <div class="swatch" style="background:#fff6ef" onclick="setBg('#fff6ef')"></div>
        <div class="swatch" style="background:linear-gradient(90deg,#ffe4ec,#fff7f0)" onclick="setBg('linear-gradient(90deg,#ffe4ec,#fff7f0)')"></div>
      </div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px dashed rgba(0,0,0,0.05)">

    <div>
      <div class="section-title">üì¶ Plantillas</div>
      <div style="display:grid;gap:8px">
        <div class="template-card" onclick="applyTemplate(1)">
          <strong>Moderno minimal</strong>
          <div style="font-size:0.85rem;color:#666">Texto + forma</div>
        </div>
        <div class="template-card" onclick="applyTemplate(2)">
          <strong>Colorido</strong>
          <div style="font-size:0.85rem;color:#666">Imagen + texto</div>
        </div>
        <div class="template-card" onclick="applyTemplate(3)">
          <strong>Tipograf√≠a</strong>
          <div style="font-size:0.85rem;color:#666">Tipograf√≠a grande</div>
        </div>
      </div>
    </div>

  </aside>

  <!-- MIDDLE: CANVAS -->
  <section class="middle">
    <div class="canvas-wrap">
      <div id="canvas"></div>
    </div>
    <div style="display:flex;gap:12px;align-items:center;">
      <div style="font-size:0.9rem;color:#444">Selecciona un elemento para ver controles ‚ûú</div>
      <div style="flex:1"></div>
      <div style="font-size:0.9rem;color:#444">Canvas: 920x600</div>
    </div>
  </section>

  <!-- RIGHT: PROPERTIES / LAYERS -->
  <aside class="right">
    <div class="section-title">üîß Propiedades</div>

    <div id="props-none">Selecciona un elemento para editar sus propiedades.</div>

    <div id="props" style="display:none">
      <label class="small">Tipo</label>
      <div id="prop-type" style="font-weight:700;margin-bottom:8px"></div>

      <label class="small">Texto</label>
      <textarea id="prop-text" class="input" rows="2" oninput="updateText()"></textarea>

      <div class="control-row">
        <div style="flex:1">
          <label class="small">Fuente</label>
          <select id="prop-font" class="input" onchange="updateFont()">
            <option>Poppins</option><option>Roboto</option><option>Montserrat</option><option>Georgia</option><option>Impact</option>
          </select>
        </div>
        <div style="width:80px">
          <label class="small">Tama√±o</label>
          <input id="prop-size" type="number" class="input" min="10" max="180" value="36" oninput="updateSize()">
        </div>
      </div>

      <label class="small">Color</label>
      <input id="prop-color" type="color" class="input" onchange="updateColor()">

      <label class="small">Opacidad</label>
      <input id="prop-opacity" type="range" min="0" max="1" step="0.05" value="1" class="range" oninput="updateOpacity()">

      <label class="small">Rotaci√≥n (deg)</label>
      <input id="prop-rotate" type="number" class="input" value="0" oninput="updateRotate()">

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn small" onclick="bringForward()">Traer adelante</button>
        <button class="btn small" onclick="sendBack()">Enviar atr√°s</button>
        <button class="btn small" onclick="duplicateItem()">Duplicar</button>
        <button class="btn ghost small" onclick="deleteItem()" style="background:transparent;border:1px solid #ccc">Borrar</button>
      </div>
    </div>

    <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(0,0,0,0.06)">

    <div class="section-title">üóÇ Capas</div>
    <div id="layers"></div>

  </aside>
</div>

<script>
/* ========== CORE ========== */
const canvas = document.getElementById('canvas');
canvas.style.left = 'auto';
canvas.style.top = 'auto';
canvas.style.position = 'relative';
canvas.style.width = '920px';
canvas.style.height = '600px';
canvas.style.margin = '0 auto';
canvas.style.background = '#fff7f0';

/* state */
let selected = null;
let zIndexCounter = 10;

/* helper: create item element wrapper */
function createItem(type, opts = {}) {
  const el = document.createElement('div');
  el.classList.add('item');
  el.dataset.type = type;
  el.style.left = (opts.x ?? 60) + 'px';
  el.style.top = (opts.y ?? 60) + 'px';
  el.style.transform = 'translate(0,0) rotate(0deg)';
  el.style.zIndex = ++zIndexCounter;
  el.style.userSelect = 'none';

  // content wrapper inside to allow text editing
  const content = document.createElement('div');
  content.className = 'content';
  content.style.pointerEvents = 'none'; // editing via controls
  el.appendChild(content);

  // handles
  const br = document.createElement('div'); br.className='handle br';
  const tl = document.createElement('div'); tl.className='handle tl';
  const rot = document.createElement('div'); rot.className='rotate-handle rotate'; rot.innerHTML = '‚§æ';

  el.appendChild(br); el.appendChild(tl); el.appendChild(rot);
  
    // --- bot√≥n BORRAR sobre el item ---
  const delBtn = document.createElement('div');
  delBtn.innerHTML = '‚úñ';
  delBtn.style.position = 'absolute';
  delBtn.style.top = '-10px';
  delBtn.style.right = '-10px';
  delBtn.style.width = '24px';
  delBtn.style.height = '24px';
  delBtn.style.background = 'var(--pr)';
  delBtn.style.color = '#fff';
  delBtn.style.borderRadius = '50%';
  delBtn.style.display = 'flex';
  delBtn.style.alignItems = 'center';
  delBtn.style.justifyContent = 'center';
  delBtn.style.cursor = 'pointer';
  delBtn.style.zIndex = '999';
  delBtn.title = 'Borrar';
  delBtn.addEventListener('click', (e) => {
    e.stopPropagation(); // evitar seleccionar el elemento
    el.remove();
    selected = null;
    document.getElementById('props').style.display='none';
    document.getElementById('props-none').style.display='block';
    refreshLayers();
  });
  el.appendChild(delBtn);


  canvas.appendChild(el);
  makeInteractable(el);
  refreshLayers();
  return el;
}

/* ========== CREATE SPECIFIC ITEMS ========== */
function addText(){ const it = createItem('text',{x:80,y:80}); it.querySelector('.content').innerHTML = `<div class="text-item" contenteditable="true" style="pointer-events:auto;">Tu texto</div>`; selectItem(it); }
function addHeading(){ const it = createItem('text',{x:100,y:60}); it.querySelector('.content').innerHTML = `<div class="text-item" contenteditable="true" style="font-size:48px;pointer-events:auto;">Titulo</div>`; selectItem(it); }
function addShape(kind='rect'){ const it = createItem('shape',{x:120,y:120}); const s=document.createElement('div'); s.className='shape'; if(kind==='circle'){ s.style.borderRadius='50%'; } it.querySelector('.content').appendChild(s); selectItem(it); }
function insertIcon(symb){ const it = createItem('icon',{x:140,y:140}); it.querySelector('.content').innerHTML = `<div style="font-size:40px;pointer-events:auto">${symb}</div>`; selectItem(it); }

/* upload image */
function handleUpload(e){
  const file = e.target.files[0]; if(!file) return;
  const url = URL.createObjectURL(file);
  const it = createItem('image',{x:140,y:140});
  const img = document.createElement('img'); img.src = url; img.className='img-item'; img.style.maxWidth='240px';
  it.querySelector('.content').appendChild(img); selectItem(it);
}

/* add image via file input programmatically */
function agregarImagen(){ const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.onchange = handleUpload; input.click(); }

/* templates */
function applyTemplate(n){
  limpiarCanvas();
  if(n===1){
    setBg('#fff7f0');
    const s = createItem('shape',{x:60,y:180}); s.querySelector('.content').innerHTML = `<div style="width:280px;height:280px;background:linear-gradient(135deg,#fff0f6,#fff7f0);border-radius:16px"></div>`;
    const t = createItem('text',{x:380,y:160}); t.querySelector('.content').innerHTML = `<div class="text-item" contenteditable="true" style="font-size:36px">Marca Minimal</div>`;
    selectItem(t);
  } else if(n===2){
    setBg('#fff6ef');
    const imgIt = createItem('image',{x:60,y:50}); imgIt.querySelector('.content').innerHTML = `<img class="img-item" src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=2d1a2c8d4b5df5ea5f4c7a7e9f5d9cda">`;
    const t = createItem('text',{x:420,y:280}); t.querySelector('.content').innerHTML = `<div class="text-item" contenteditable="true" style="font-size:40px">Tu producto</div>`;
    selectItem(t);
  } else {
    setBg('#fff7f0');
    const t = createItem('text',{x:140,y:140}); t.querySelector('.content').innerHTML = `<div class="text-item" contenteditable="true" style="font-size:64px">PUBLIFLY</div>`;
    selectItem(t);
  }
}

/* set canvas background */
function setBg(v){ canvas.style.background = v; }

/* clear */
function limpiarCanvas(){ if(!confirm('Limpiar lienzo?')) return; canvas.innerHTML=''; selected=null; refreshLayers(); document.getElementById('props').style.display='none'; document.getElementById('props-none').style.display='block'; }

/* ========== INTERACTIONS: drag, resize, rotate, select ========== */
function makeInteractable(el){
  // basic style
  el.style.left = el.style.left || '60px';
  el.style.top = el.style.top || '60px';

  // event: select
  el.addEventListener('mousedown', (e)=>{
    e.stopPropagation();
    selectItem(el);
  });

  // dragging
  let dragging=false, offsetX=0, offsetY=0;
  el.addEventListener('pointerdown', (ev)=>{
    if(ev.target.classList.contains('br')||ev.target.classList.contains('tl')||ev.target.classList.contains('rotate')) return;
    dragging=true;
    el.setPointerCapture(ev.pointerId);
    offsetX = ev.clientX - el.offsetLeft;
    offsetY = ev.clientY - el.offsetTop;
  });
  document.addEventListener('pointermove', (ev)=>{
    if(!dragging) return;
    el.style.left = (ev.clientX - offsetX) + 'px';
    el.style.top = (ev.clientY - offsetY) + 'px';
    updatePropPosition(el);
  });
  document.addEventListener('pointerup', ()=>{ dragging=false; });

  // resize (bottom-right handle)
  const br = el.querySelector('.br');
  let resizing=false, startW=0,startH=0,startX=0,startY=0;
  br.addEventListener('pointerdown', (e)=>{
    e.stopPropagation(); resizing=true;
    startW = el.offsetWidth; startH = el.offsetHeight;
    startX = e.clientX; startY = e.clientY;
    br.setPointerCapture(e.pointerId);
  });
  document.addEventListener('pointermove', (e)=>{
    if(!resizing) return;
    const dx = e.clientX - startX; const dy = e.clientY - startY;
    el.style.width = Math.max(60, startW + dx) + 'px';
    el.style.height = Math.max(40, startH + dy) + 'px';
  });
  document.addEventListener('pointerup', ()=>{ resizing=false; });

  // rotate
  const rh = el.querySelector('.rotate-handle');
  let rotating=false, centerX=0,centerY=0, startAngle=0;
  rh.addEventListener('pointerdown', (e)=>{
    e.stopPropagation(); rotating=true;
    const rect = el.getBoundingClientRect();
    centerX = rect.left + rect.width/2; centerY = rect.top + rect.height/2;
    startAngle = getRotation(el);
    rh.setPointerCapture(e.pointerId);
  });
  document.addEventListener('pointermove', (e)=>{
    if(!rotating) return;
    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180/Math.PI;
    const rot = angle + 90; // adjust
    el.style.transform = `rotate(${rot}deg)`;
    updatePropRotation(el);
  });
  document.addEventListener('pointerup', ()=>{ rotating=false; });

  // double click: edit text content directly (if text)
  el.addEventListener('dblclick', (e)=>{
    const textEl = el.querySelector('[contenteditable]');
    if(textEl){
      textEl.focus();
      // allow pointer events for editing
      textEl.style.pointerEvents='auto';
    }
  });
}

/* get rotation degrees from transform */
function getRotation(el){
  const st = window.getComputedStyle(el);
  const tm = st.transform || "none";
  if(tm === "none") return 0;
  const values = tm.split('(')[1].split(')')[0].split(',');
  const a = values[0], b = values[1];
  const angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
  return angle;
}

/* ========== SELECTION & PROPERTIES ========== */
function selectItem(el){
  // deselect previous
  if(selected){
    selected.classList.remove('selected');
  }
  selected = el;
  el.classList.add('selected');
  // show properties
  document.getElementById('props-none').style.display='none';
  document.getElementById('props').style.display='block';
  populateProps(el);
  refreshLayers();
}

/* populate right panel with selected item */
function populateProps(el){
  const type = el.dataset.type;
  document.getElementById('prop-type').innerText = type.toUpperCase();
  // set text (if text)
  const textNode = el.querySelector('[contenteditable]');
  if(textNode){
    document.getElementById('prop-text').value = textNode.innerText;
    document.getElementById('prop-text').style.display='block';
  } else {
    document.getElementById('prop-text').value = '';
    document.getElementById('prop-text').style.display='block';
  }
  // font
  document.getElementById('prop-font').value = (textNode? getComputedStyle(textNode).fontFamily.replace(/"/g,''): 'Poppins');
  document.getElementById('prop-size').value = parseInt(window.getComputedStyle(el.querySelector('.content')||el).fontSize) || parseInt(getComputedStyle(textNode || el).fontSize) || 36;
  document.getElementById('prop-color').value = rgbToHex(getComputedStyle(textNode||el.querySelector('.content')||el).color || '#333');
  document.getElementById('prop-opacity').value = parseFloat(getComputedStyle(el).opacity) || 1;
  document.getElementById('prop-rotate').value = Math.round(getRotation(el));
}

/* update functions called by controls */
function updateText(){
  if(!selected) return;
  const t = selected.querySelector('[contenteditable]');
  if(t) t.innerText = document.getElementById('prop-text').value;
}
function updateFont(){
  if(!selected) return;
  const t = selected.querySelector('[contenteditable]');
  if(t) t.style.fontFamily = document.getElementById('prop-font').value;
}
function updateSize(){
  if(!selected) return;
  const size = document.getElementById('prop-size').value;
  const t = selected.querySelector('[contenteditable]');
  if(t){ t.style.fontSize = size+'px'; }
  else { selected.style.fontSize = size+'px'; }
}
function updateColor(){
  if(!selected) return;
  const v = document.getElementById('prop-color').value;
  const t = selected.querySelector('[contenteditable]');
  if(t) t.style.color = v;
  else {
    const img = selected.querySelector('img');
    if(!img) selected.style.background = v;
  }
}
function updateOpacity(){ if(!selected) return; selected.style.opacity = document.getElementById('prop-opacity').value; }
function updateRotate(){ if(!selected) return; selected.style.transform = `rotate(${document.getElementById('prop-rotate').value}deg)`; }

/* ordering / duplicate / delete */
function bringForward(){ if(!selected) return; selected.style.zIndex = ++zIndexCounter; refreshLayers(); }
function sendBack(){ if(!selected) return; selected.style.zIndex = 1; refreshLayers(); }
function duplicateItem(){
  if(!selected) return;
  const copy = selected.cloneNode(true);
  copy.style.left = (parseInt(selected.style.left||0)+20)+'px';
  copy.style.top = (parseInt(selected.style.top||0)+20)+'px';
  canvas.appendChild(copy);
  makeInteractable(copy);
  refreshLayers();
}
function deleteItem(){ if(!selected) return; selected.remove(); selected=null; document.getElementById('props').style.display='none'; document.getElementById('props-none').style.display='block'; refreshLayers(); }

/* layers list */
function refreshLayers(){
  const layers = document.getElementById('layers');
  layers.innerHTML='';
  const items = Array.from(canvas.children).reverse();
  items.forEach(it=>{
    const row = document.createElement('div'); row.className='layer';
    const label = document.createElement('div'); label.className='hb'; label.innerHTML = `<div style="width:12px;height:12px;background:#eee;border-radius:3px;margin-right:8px"></div> ${it.dataset.type || 'item'}`;
    row.appendChild(label);
    const actions = document.createElement('div'); actions.innerHTML = `<button onclick="selectLayer('${it.style.zIndex}')">üîç</button>`;
    row.appendChild(actions);
    row.onclick = ()=>{ selectItem(it); };
    layers.appendChild(row);
  });
}

/* helper: select layer by z-index (used above) */
function selectLayer(z){ const found = Array.from(canvas.children).find(c=>c.style.zIndex==z); if(found) selectItem(found); }

/* helper: update props position when dragging */
function updatePropPosition(el){ if(selected===el) populateProps(el); }

/* utility: rgb to hex */
function rgbToHex(rgb){
  if(!rgb) return '#000000';
  const m = rgb.match(/\d+/g);
  if(!m) return '#000';
  return '#'+((1<<24)+(parseInt(m[0])<<16)+(parseInt(m[1])<<8)+parseInt(m[2])).toString(16).slice(1);
}

/* ========== Export (html2canvas) ========== */
function exportarPNG(){
  // temporarily remove selection outlines for clean export
  const prevSel = selected;
  const sels = document.querySelectorAll('.selected'); sels.forEach(s=>s.classList.remove('selected'));
  html2canvas(canvas, {backgroundColor: null, scale:2}).then(c=>{
    const a = document.createElement('a'); a.href = c.toDataURL('image/png'); a.download = 'publifly_design.png'; a.click();
    if(prevSel) prevSel.classList.add('selected');
  });
}

/* quick save (localStorage) */
function guardarProyecto(){
  const data = [];
  Array.from(canvas.children).forEach(child=>{
    const html = child.outerHTML;
    data.push(html);
  });
  localStorage.setItem('publifly_project', JSON.stringify({bg:canvas.style.background||'',items:data}));
  alert('Proyecto guardado en localStorage.');
}
function cargarProyecto(){
  const raw = localStorage.getItem('publifly_project');
  if(!raw) return;
  const obj = JSON.parse(raw);
  canvas.innerHTML='';
  if(obj.bg) canvas.style.background = obj.bg;
  (obj.items||[]).forEach(html=>{
    const div = document.createElement('div'); div.innerHTML = html;
    const node = div.firstChild;
    canvas.appendChild(node);
    makeInteractable(node);
  });
  refreshLayers();
}

/* keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(e.key==='Delete' && selected) deleteItem();
  if((e.ctrlKey||e.metaKey) && e.key==='d'){ e.preventDefault(); duplicateItem(); }
});

/* ========== Helpers: export, gallery ========== */
function abrirGaleria(){ document.querySelector('.sidebar').scrollTo({top:0,behavior:'smooth'}); alert('Selecciona una plantilla en la Biblioteca a la izquierda.'); }

/* ========== Init: load sample template ========== */
applyTemplate(1);
cargarProyecto();
<section id="misDise√±os">
  <h2>Mis Dise√±os Guardados</h2>
  <div id="contenedorGuardados" class="galeria"></div>
</section>

function guardarDiseno() {
  // Crear objeto del dise√±o
  const diseno = {
    nombre: nombre.value,
    color: color.value,
    fuente: fuente.value,
    tamano: tamano.value,
    imagen: canvas.toDataURL()
  };

  // Guardarlo en LocalStorage
  let guardados = JSON.parse(localStorage.getItem("logos")) || [];
  guardados.push(diseno);
  localStorage.setItem("logos", JSON.stringify(guardados));

  // Actualizar visualizaci√≥n
  mostrarGuardados();
}

function mostrarGuardados() {
  const contenedor = document.getElementById("contenedorGuardados");
  contenedor.innerHTML = "";
  const guardados = JSON.parse(localStorage.getItem("logos")) || [];
  
  guardados.forEach((d, index) => {
    const div = document.createElement("div");
    div.className = "plantilla-card";
    div.innerHTML = `
      <img src="${d.imagen}" alt="${d.nombre}">
      <h3>${d.nombre}</h3>
      <button onclick="editarDiseno(${index})">Editar</button>
      <button onclick="borrarDiseno(${index})">Borrar</button>
    `;
    contenedor.appendChild(div);
  });
}

function editarDiseno(index) {
  const guardados = JSON.parse(localStorage.getItem("logos")) || [];
  const d = guardados[index];
  nombre.value = d.nombre;
  color.value = d.color;
  fuente.value = d.fuente;
  tamano.value = d.tamano;
  // Dibujar de nuevo en canvas
  textoLogo.textContent = d.nombre;
  textoLogo.style.color = d.color;
  textoLogo.style.fontFamily = d.fuente;
  textoLogo.style.fontSize = d.tamano + "px";
}

function borrarDiseno(index) {
  let guardados = JSON.parse(localStorage.getItem("logos")) || [];
  guardados.splice(index, 1);
  localStorage.setItem("logos", JSON.stringify(guardados));
  mostrarGuardados();
}

// Inicializar
mostrarGuardados();

</script>
</body>
</html>